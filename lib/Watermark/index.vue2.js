"use strict";const e=require("vue"),t=require("../node_modules/@vueuse/core/index.js");require("../node_modules/tinycolor2/esm/tinycolor.js"),require("../_shared/utils/dom.js");const a=require("../_shared/utils/is.js");require("../_shared/utils/time.js"),require("../Empty/index.js"),require("../_shared/icons/_Icon.vue.js");const l=e.defineComponent({name:"Watermark",__name:"index",props:{content:{default:""},image:{default:""},width:{default:void 0},height:{default:void 0},gap:{default:()=>[90,90]},offset:{default:()=>[45,45]},rotate:{default:-22},font:{default:()=>({color:"rgba(0, 0, 0, 0.15)",fontSize:16,fontFamily:"sans-serif",fontStyle:"normal",textAlign:"center",fontWeight:"normal"})},zIndex:{default:6},alpha:{default:1},grayscale:{type:Boolean,default:!1},repeat:{type:Boolean,default:!0},staggered:{type:Boolean,default:!0},antiTamper:{type:Boolean,default:!0}},setup(l){const o=l,{width:r,height:n,alpha:u,image:i,grayscale:s,rotate:d,repeat:v,staggered:c,antiTamper:f,zIndex:p}=e.toRefs(o),m=e.ref(),g=window.devicePixelRatio||1,h=e.ref(new Map),x=e.computed((()=>{var e;return null==(e=o.font)?void 0:e.color})),y=e.computed((()=>{var e;return(null==(e=o.font)?void 0:e.fontSize)??16})),$=e.computed((()=>{var e;return(null==(e=o.font)?void 0:e.fontWeight)??"normal"})),b=e.computed((()=>{var e;return(null==(e=o.font)?void 0:e.fontStyle)??"normal"})),w=e.computed((()=>{var e;return(null==(e=o.font)?void 0:e.fontFamily)??"sans-serif"})),I=e.computed((()=>{var e;return(null==(e=o.font)?void 0:e.textAlign)??"center"})),k=e.computed((()=>a.isArray(o.content)?o.content:[o.content])),_=e.computed((()=>{var e;return(null==(e=o.gap)?void 0:e[0])??90})),j=e.computed((()=>{var e;return(null==(e=o.gap)?void 0:e[1])??90})),A=e.computed((()=>_.value/2)),q=e.computed((()=>j.value/2)),z=e.computed((()=>{var e;return(null==(e=o.offset)?void 0:e[0])??A.value})),B=e.computed((()=>{var e;return(null==(e=o.offset)?void 0:e[1])??q.value})),S=e.computed((()=>{const e=z.value-A.value,t=B.value-q.value;return{position:"absolute",left:e>0?`${e}px`:0,top:t>0?`${t}px`:0,width:e>0?`calc(100% - ${e}px)`:"100%",height:t>0?`calc(100% - ${t}px)`:"100%",pointerEvents:"none",backgroundRepeat:o.repeat?"repeat":"no-repeat",backgroundPosition:`${e>0?0:e}px ${t>0?0:t}px`,zIndex:p.value??6}})),E=e.computed((()=>c.value&&v.value));const M=(e,t)=>{var a,l;if(m.value){const o=h.value.get(m.value);o&&(m.value.contains(o)&&m.value.removeChild(o),h.value.delete(m.value));const r=document.createElement("div");r.setAttribute("style",(l={...S.value,backgroundImage:`url('${e}')`,backgroundSize:`${t}px`},Object.entries(l).map((([e,t])=>{return`${a=e,a.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase()}:${t}`;var a})).join(";"))),null==(a=m.value)||a.append(r),h.value.set(m.value,r)}},C=()=>{var e;const t=document.createElement("canvas"),a=t.getContext("2d");if(!a)return;const[l,o]=(e=>{let t=120,a=28;if(!i.value&&e.measureText){e.font=`${y.value}px ${w.value}`;const l=k.value.map((t=>e.measureText(t).width));t=Math.ceil(Math.max(...l)),a=y.value*k.value.length+3*(k.value.length-1)}return[r.value??t,n.value??a]})(a),v=l*g,c=o*g,f=(_.value+l)*g,p=(j.value+o)*g,m=_.value/2*g,h=j.value/2*g,A=f/2,q=p/2,z=E.value?2:1,B=(_.value+l)*z;t.width=f*z,t.height=p*z,a.globalAlpha=u.value,a.save(),a.translate(A,q),a.rotate(Math.PI/180*d.value),a.translate(-A,-q);const S=()=>{a.restore(),E.value&&a.drawImage(t,0,0,f,p,f,p,f,p),s.value&&function(e){const t=e.getContext("2d");if(!t)return;const a=t.getImageData(0,0,e.width,e.height),{data:l}=a;for(let o=0;o<l.length;o+=4){const e=(l[o]+l[o+1]+l[o+2])/3;l[o]=e,l[o+1]=e,l[o+2]=e}t.putImageData(a,0,0)}(t),M(t.toDataURL(),B)};if(i.value){const e=new Image;e.onload=()=>{a.drawImage(e,m,h,v,c),S()},e.crossOrigin="anonymous",e.referrerPolicy="no-referrer",e.src=i.value}else{const t=Number(y.value)*g;a.font=`${b.value} normal ${$.value} ${t}px/${o}px ${w.value}`,a.fillStyle=x.value,a.textAlign=I.value,a.textBaseline="top",a.translate(v/2,0),null==(e=k.value)||e.forEach(((e,l)=>{a.fillText(e??"",m,h+l*(t+3*g))})),S()}},R=e=>Array.from(h.value.values()).includes(e);return e.watch(o,C,{deep:!0,flush:"post"}),t.useMutationObserver(m,(e=>{if(f.value)for(const t of e){const e=Array.from(t.removedNodes).some((e=>R(e))),a="attributes"===t.type&&R(t.target);if(e||a){C();break}}}),{attributes:!0,childList:!0,characterData:!0,subtree:!0}),e.onMounted((()=>{C()})),(t,a)=>(e.openBlock(),e.createElementBlock("div",{class:"yc-watermark",ref_key:"containerRef",ref:m},[e.renderSlot(t.$slots,"default",{},void 0,!0)],512))}});module.exports=l;
